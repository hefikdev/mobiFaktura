version: '3.8'

# ========================================================
# mobiFaktura Docker Compose - All Environments
# ========================================================
# ONE FILE FOR BOTH DEVELOPMENT AND PRODUCTION
# Configure via .env file for all settings
# ========================================================

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  postgres:
    image: postgres:16-alpine
    container_name: mobifaktura_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mobifaktura}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-mobifaktura_secret}
      POSTGRES_DB: ${POSTGRES_DB:-mobifaktura}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # In dev: expose port, in production: only internal (set POSTGRES_PORT in .env)
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - mobifaktura_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mobifaktura}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SeaweedFS S3-compatible Storage - Master
  # ============================================
  # Master server provides:
  # - Web UI for cluster management (http://localhost:9333)
  # - Volume topology and status monitoring
  # - File lookup and metadata
  # - Cluster coordination
  seaweedfs-master:
    image: chrislusf/seaweedfs:4.07
    container_name: mobifaktura_seaweedfs_master
    restart: unless-stopped
    command: "master -ip=seaweedfs-master -port=9333"
    ports:
      - "${SEAWEEDFS_MASTER_PORT:-9333}:9333"  # Web UI + API
    networks:
      - mobifaktura_network
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:9333/cluster/status"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SeaweedFS Volume Server
  # ============================================
  # Stores actual file data with replication
  seaweedfs-volume:
    image: chrislusf/seaweedfs:4.07
    container_name: mobifaktura_seaweedfs_volume
    restart: unless-stopped
    command: "volume -mserver=seaweedfs-master:9333 -port=8080 -max=100"
    depends_on:
      seaweedfs-master:
        condition: service_healthy
    volumes:
      - seaweedfs_data:/data
    ports:
      - "${SEAWEEDFS_VOLUME_PORT:-8080}:8080"  # Volume HTTP API
    networks:
      - mobifaktura_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SeaweedFS Filer
  # ============================================
  # Provides POSIX filesystem interface
  seaweedfs-filer:
    image: chrislusf/seaweedfs:4.07
    container_name: mobifaktura_seaweedfs_filer
    restart: unless-stopped
    command: "filer -master=seaweedfs-master:9333"
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    ports:
      - "${SEAWEEDFS_FILER_PORT:-8888}:8888"  # Filer HTTP API
    networks:
      - mobifaktura_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SeaweedFS S3 Gateway
  # ============================================
  # S3-compatible API with authentication
  # Configured via s3.config.json for access control
  seaweedfs-s3:
    image: chrislusf/seaweedfs:4.07
    container_name: mobifaktura_seaweedfs_s3
    restart: unless-stopped
    command: "s3 -filer=seaweedfs-filer:8888 -config=/etc/seaweedfs/s3.config.json"
    depends_on:
      - seaweedfs-filer
    volumes:
      - ./dev_data/seaweedfs/s3.config.json:/etc/seaweedfs/s3.config.json:ro
    ports:
      - "${S3_PORT:-9000}:9000"  # S3 API endpoint
    networks:
      - mobifaktura_network
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:9000/"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  # SeaweedFS Bucket Initialization
  # ============================================
  seaweedfs-init:
    image: amazon/aws-cli:latest
    container_name: mobifaktura_seaweedfs_init
    depends_on:
      seaweedfs-s3:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY:-mobifaktura_s3_internal}
      AWS_SECRET_ACCESS_KEY: ${S3_SECRET_KEY:-mobifaktura_s3_secret_key_2026}
      AWS_DEFAULT_REGION: us-east-1
      AWS_ENDPOINT_URL: http://seaweedfs-s3:9000
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for SeaweedFS S3 to be fully ready...';
      sleep 5;
      aws s3 mb s3://${S3_BUCKET:-invoices} --endpoint-url http://seaweedfs-s3:9000 || echo 'Bucket already exists';
      echo 'SeaweedFS bucket initialized successfully';
      exit 0;
      "
    networks:
      - mobifaktura_network

  # Lightweight PostgreSQL web UI (pgweb)
  # - Exposes Postgres over HTTP (default :8081). Control host mapping with PGWEB_PORT in your .env
  # - WARNING: consider protecting this in production (reverse-proxy auth / VPN) before exposing publicly.
  pgweb:
    image: sosedoff/pgweb:latest
    container_name: mobifaktura_pgweb
    restart: unless-stopped
    environment:
      # By default disable SSL for local/dev Postgres. In production override
      # either PGWEB_SSLMODE or provide a full PGWEB_DATABASE_URL in your .env.
      DATABASE_URL: "${PGWEB_DATABASE_URL:-postgres://${POSTGRES_USER:-mobifaktura}:${POSTGRES_PASSWORD:-mobifaktura_secret}@postgres:5432/${POSTGRES_DB:-mobifaktura}?sslmode=${PGWEB_SSLMODE:-disable}}"
      PGWEB_SSLMODE: ${PGWEB_SSLMODE:-disable}
    # Safety: publish pgweb to localhost only (not publicly routable)
    ports:
      - "127.0.0.1:${PGWEB_PORT:-8081}:8081"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8081/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - mobifaktura_network

  # ============================================
  # Next.js Application
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mobifaktura_app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      seaweedfs-s3:
        condition: service_healthy
      seaweedfs-init:
        condition: service_completed_successfully
    environment:
      # Database
      DATABASE_URL: postgres://${POSTGRES_USER:-mobifaktura}:${POSTGRES_PASSWORD:-mobifaktura_secret}@postgres:5432/${POSTGRES_DB:-mobifaktura}
      
      # SeaweedFS S3 Storage
      S3_ENDPOINT: seaweedfs-s3
      S3_PORT: 9000
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-mobifaktura_s3_internal}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-mobifaktura_s3_secret_key_2026}
      S3_BUCKET: ${S3_BUCKET:-invoices}
      S3_USE_SSL: "false"
      
      # Authentication & Security
      JWT_SECRET: "${JWT_SECRET:?Error: JWT_SECRET not set in .env file}"
      SESSION_COOKIE_NAME: ${SESSION_COOKIE_NAME:-mobifaktura_session}
      COOKIE_DOMAIN: localhost
      
      # Application Settings
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "3000:3000"
    volumes:
      - app_logs:/app/logs
    networks:
      - mobifaktura_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

# ============================================
# Networks
# ============================================
networks:
  mobifaktura_network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
  seaweedfs_data:
    driver: local
  app_logs:
    driver: local

# ============================================
# Usage Instructions
# ============================================
# DEVELOPMENT (local services exposed):
#   docker-compose up
#   - All services on localhost
#   - PostgreSQL: localhost:5432
#   - SeaweedFS S3: localhost:9000
#   - SeaweedFS Master UI: localhost:9333 (browse files, volumes, topology)
#   - SeaweedFS Volume: localhost:8080
#   - SeaweedFS Filer: localhost:8888
#   - App: localhost:3000
#   - Pgweb (Postgres GUI): localhost:8081 (set PGWEB_PORT in .env to change)
#
# SEAWEEDFS WEB UI:
#   Access at: http://localhost:9333
#   Features:
#   - View cluster topology and status
#   - Browse all volumes and files
#   - Monitor storage usage and health
#   - View file locations and replication
#
# PRODUCTION (only app exposed):
#   Set in .env: NODE_ENV=production
#   Set in .env: NEXT_PUBLIC_APP_URL=https://yourdomain.com
#   Run: docker-compose up -d
#   - Services only accessible internally
#   - Automatic backups with cron
#
# Common Commands:
#   View app logs:        docker-compose logs -f app
#   Database shell:       docker-compose exec postgres psql -U mobifaktura -d mobifaktura
#   SeaweedFS Master UI:  http://localhost:9333
#   Check storage usage:  curl http://localhost:9333/vol/status
# ============================================
