# mobiFaktura - Complete Architecture

Complete system architecture showing all components, data flow, and interactions.

## ğŸ—ï¸ System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            MOBIFAKTURA SYSTEM                                â”‚
â”‚                         Invoice Management Platform                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Browser   â”‚
                              â”‚  (Client)   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ HTTPS
                                     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Docker: mobifaktura_app    â”‚
                    â”‚      Next.js 16 Application    â”‚
                    â”‚         Port: 3000             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
                    â–¼                â–¼                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PostgreSQL  â”‚  â”‚    MinIO    â”‚  â”‚  Log Files   â”‚
        â”‚   Database    â”‚  â”‚   Storage   â”‚  â”‚  /app/logs   â”‚
        â”‚   Port: 5432  â”‚  â”‚  Port: 9000 â”‚  â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                  â”‚
                â”‚                  â”‚
                â–¼                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Backup Serviceâ”‚  â”‚ Backup Data â”‚
        â”‚  (Cron Jobs)  â”‚  â”‚  /backups   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Docker Containers

### 1. **mobifaktura_app** (Next.js Application)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js 16 Application                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Middleware  â”‚â†’ â”‚  tRPC Router â”‚â†’ â”‚ Business Logic â”‚        â”‚
â”‚  â”‚ (Auth/IP)   â”‚  â”‚              â”‚  â”‚                â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                  Application Layers                   â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ â†’ Client Components (React 19)                       â”‚      â”‚
â”‚  â”‚ â†’ Server Components (RSC)                            â”‚      â”‚
â”‚  â”‚ â†’ API Routes (/api/*)                                â”‚      â”‚
â”‚  â”‚ â†’ tRPC Procedures                                    â”‚      â”‚
â”‚  â”‚ â†’ Database Layer (Drizzle ORM)                       â”‚      â”‚
â”‚  â”‚ â†’ Storage Layer (MinIO Client)                       â”‚      â”‚
â”‚  â”‚ â†’ Auth Layer (JWT + Argon2)                          â”‚      â”‚
â”‚  â”‚ â†’ Logging Layer (Pino)                               â”‚      â”‚
â”‚  â”‚ â†’ Rate Limiting (In-Memory)                          â”‚      â”‚
â”‚  â”‚ â†’ Cron Jobs (Cleanup tasks)                          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                  â”‚
â”‚  Volumes:                                                        â”‚
â”‚  â€¢ /app/logs â†’ app_logs (persistent logs)                      â”‚
â”‚                                                                  â”‚
â”‚  Environment:                                                    â”‚
â”‚  â€¢ NODE_ENV=production                                          â”‚
â”‚  â€¢ DATABASE_URL=postgres://...                                  â”‚
â”‚  â€¢ MINIO_ENDPOINT=minio:9000                                   â”‚
â”‚  â€¢ LOG_LEVEL=info                                              â”‚
â”‚                                                                  â”‚
â”‚  Health Check:                                                   â”‚
â”‚  â€¢ wget --spider http://localhost:3000/api/health              â”‚
â”‚  â€¢ Interval: 30s, Timeout: 10s, Retries: 3                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **mobifaktura_postgres** (Database)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PostgreSQL 16 Database                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Tables:                                                         â”‚
â”‚  â”œâ”€ users              (User accounts & roles)                  â”‚
â”‚  â”œâ”€ sessions           (Active user sessions)                   â”‚
â”‚  â”œâ”€ companies          (Company information)                    â”‚
â”‚  â”œâ”€ invoices           (Invoice data & metadata)                â”‚
â”‚  â”œâ”€ invoice_edit_history (Edit history tracking)                â”‚
â”‚  â”œâ”€ notifications      (User notifications)                     â”‚
â”‚  â”œâ”€ saldo_transactions (Balance change tracking)                â”‚
â”‚  â”œâ”€ invoice_deletion_requests (Deletion request workflow)       â”‚
â”‚  â”œâ”€ budget_requests    (Budget increase requests)               â”‚
â”‚  â”œâ”€ login_logs         (Login activity tracking)                â”‚
â”‚  â””â”€ login_attempts     (Failed login attempts)                  â”‚
â”‚                                                                  â”‚
â”‚  Indexes:                                                        â”‚
â”‚  â€¢ Performance indexes on frequently queried fields             â”‚
â”‚  â€¢ Status indexes for workflow tables                            â”‚
â”‚  â€¢ Foreign key indexes for referential integrity                â”‚
â”‚                                                                  â”‚
â”‚  Volumes:                                                        â”‚
â”‚  â€¢ postgres_data â†’ /var/lib/postgresql/data                    â”‚
â”‚                                                                  â”‚
â”‚  Health Check:                                                   â”‚
â”‚  â€¢ pg_isready -U mobifaktura                                    â”‚
â”‚  â€¢ Interval: 10s, Timeout: 5s, Retries: 5                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **mobifaktura_minio** (Object Storage)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MinIO S3 Storage                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Buckets:                                                        â”‚
â”‚  â””â”€ invoices (private)                                          â”‚
â”‚     â””â”€ Invoice images/scans                                     â”‚
â”‚                                                                  â”‚
â”‚  Ports:                                                          â”‚
â”‚  â€¢ 9000: S3 API                                                 â”‚
â”‚  â€¢ 9001: Web Console                                            â”‚
â”‚                                                                  â”‚
â”‚  Volumes:                                                        â”‚
â”‚  â€¢ minio_data â†’ /data                                           â”‚
â”‚                                                                  â”‚
â”‚  Health Check:                                                   â”‚
â”‚  â€¢ curl -f http://localhost:9000/minio/health/live             â”‚
â”‚  â€¢ Interval: 30s, Timeout: 20s, Retries: 3                    â”‚
â”‚                                                                  â”‚
â”‚  Access:                                                         â”‚
â”‚  â€¢ Internal: minio:9000 (app â†” minio)                         â”‚
â”‚  â€¢ External: localhost:9000, localhost:9001 (console)          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. **mobifaktura_minio_init** (Initialization)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MinIO Bucket Initialization                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  One-time setup task that:                                      â”‚
â”‚  1. Waits for MinIO to be healthy                              â”‚
â”‚  2. Creates 'invoices' bucket                                   â”‚
â”‚  3. Sets bucket to private access                              â”‚
â”‚  4. Exits after completion                                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. **mobifaktura_backup** (Backup Service)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Automated Backup Service                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Cron Schedule: 0 1 * * * (Daily at 1 AM)                      â”‚
â”‚                                                                  â”‚
â”‚  Tasks:                                                          â”‚
â”‚  1. PostgreSQL Backup                                           â”‚
â”‚     â€¢ pg_dump to /backups/postgres/                            â”‚
â”‚     â€¢ Format: backup_YYYYMMDD_HHMMSS.sql.gz                   â”‚
â”‚     â€¢ Retention: 30 days                                        â”‚
â”‚                                                                  â”‚
â”‚  2. MinIO Backup                                                â”‚
â”‚     â€¢ mc mirror to /backups/minio/                             â”‚
â”‚     â€¢ Format: backup_YYYYMMDD_HHMMSS/                         â”‚
â”‚     â€¢ Retention: 30 days                                        â”‚
â”‚                                                                  â”‚
â”‚  Volumes:                                                        â”‚
â”‚  â€¢ backup_data â†’ /backups                                      â”‚
â”‚  â€¢ ./scripts/backups â†’ /scripts (read-only)                   â”‚
â”‚                                                                  â”‚
â”‚  Manual Commands:                                                â”‚
â”‚  â€¢ npm run backup:postgres                                      â”‚
â”‚  â€¢ npm run backup:minio                                         â”‚
â”‚  â€¢ npm run backup:all                                           â”‚
â”‚  â€¢ npm run backup:list                                          â”‚
â”‚  â€¢ npm run restore:postgres                                     â”‚
â”‚  â€¢ npm run restore:minio                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow Diagrams

### User Authentication Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚         â”‚ Middleware â”‚         â”‚   tRPC   â”‚         â”‚ Database â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚  POST /login      â”‚                     â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                    â”‚
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚              Check rate limit           â”‚                    â”‚
   â”‚              (10 req/min)               â”‚                    â”‚
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚                   â”‚  auth.login()       â”‚                    â”‚
   â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚                   â”‚                     â”‚  Verify password   â”‚
   â”‚                   â”‚                     â”‚  (Argon2)          â”‚
   â”‚                   â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚                   â”‚                     â”‚  User data         â”‚
   â”‚                   â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚                   â”‚                     â”‚  Create session    â”‚
   â”‚                   â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚                   â”‚                     â”‚  Log login event   â”‚
   â”‚                   â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚                   â”‚  JWT + Session      â”‚                    â”‚
   â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚                   â”‚                     â”‚                    â”‚
   â”‚  Set-Cookie       â”‚                     â”‚                    â”‚
   â”‚  + Redirect       â”‚                     â”‚                    â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚
   â”‚                   â”‚                     â”‚                    â”‚
```

### Invoice Upload Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚    â”‚ Middleware â”‚    â”‚   tRPC   â”‚    â”‚ Database â”‚    â”‚ MinIO â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”˜
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚  POST invoice image            â”‚               â”‚              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚         Auth + Rate limit      â”‚               â”‚              â”‚
   â”‚         (100 write/min)        â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚  createInvoice()â”‚               â”‚              â”‚
   â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚  Generate key â”‚              â”‚
   â”‚              â”‚                 â”‚  (UUID)       â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚  Upload image â”‚              â”‚
   â”‚              â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚  Save metadataâ”‚              â”‚
   â”‚              â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚  Create       â”‚              â”‚
   â”‚              â”‚                 â”‚  notification â”‚              â”‚
   â”‚              â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚  Log event    â”‚              â”‚
   â”‚              â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚              â”‚  Invoice data   â”‚               â”‚              â”‚
   â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
   â”‚  Success     â”‚                 â”‚               â”‚              â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚               â”‚              â”‚
   â”‚              â”‚                 â”‚               â”‚              â”‚
```

### Invoice Review Flow (Accountant)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Accountant â”‚    â”‚   tRPC   â”‚    â”‚ Database â”‚    â”‚ MinIO â”‚    â”‚   User   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚  Get pending  â”‚               â”‚              â”‚             â”‚
      â”‚  invoices     â”‚               â”‚              â”‚             â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚  Query        â”‚              â”‚             â”‚
      â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚  Invoice list â”‚              â”‚             â”‚
      â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚  Invoices +   â”‚               â”‚              â”‚             â”‚
      â”‚  image URLs   â”‚               â”‚              â”‚             â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚  View image   â”‚               â”‚              â”‚             â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚  Get signed   â”‚              â”‚             â”‚
      â”‚               â”‚  URL          â”‚              â”‚             â”‚
      â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚  Image URL    â”‚               â”‚              â”‚             â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚  Approve/     â”‚               â”‚              â”‚             â”‚
      â”‚  Reject       â”‚               â”‚              â”‚             â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚  Update       â”‚              â”‚             â”‚
      â”‚               â”‚  status       â”‚              â”‚             â”‚
      â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚  Create       â”‚              â”‚             â”‚
      â”‚               â”‚  notification â”‚              â”‚             â”‚
      â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚  Log event    â”‚              â”‚             â”‚
      â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚  Success      â”‚               â”‚              â”‚             â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
      â”‚               â”‚               â”‚  Push notification          â”‚
      â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚               â”‚               â”‚              â”‚             â”‚
```

---

## ğŸ—‚ï¸ Application Structure

### Directory Tree
```
mobiFaktura/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                      # Next.js 16 App Router
â”‚   â”‚   â”œâ”€â”€ layout.tsx           # Root layout
â”‚   â”‚   â”œâ”€â”€ page.tsx             # Landing page (â†’ /login)
â”‚   â”‚   â”œâ”€â”€ globals.css          # Global styles
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ login/               # Login page
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ register/            # Registration page
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ a/                   # Authenticated routes
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx       # Auth layout
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/       # Dashboard
â”‚   â”‚   â”‚   â”œâ”€â”€ invoices/        # Invoice management
â”‚   â”‚   â”‚   â”œâ”€â”€ profile/         # User profile
â”‚   â”‚   â”‚   â”œâ”€â”€ notifications/   # Notifications
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/          # Admin panel
â”‚   â”‚   â”‚   â””â”€â”€ analytics/       # Analytics (accountant)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                 # API Routes
â”‚   â”‚   â”‚   â”œâ”€â”€ health/         # Health check endpoint
â”‚   â”‚   â”‚   â””â”€â”€ trpc/           # tRPC handler
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ docs/                # Documentation pages
â”‚   â”‚       â””â”€â”€ credits/
â”‚   â”‚
â”‚   â”œâ”€â”€ components/              # React Components
â”‚   â”‚   â”œâ”€â”€ ui/                 # Shadcn UI components
â”‚   â”‚   â”œâ”€â”€ *-header.tsx        # Role-based headers
â”‚   â”‚   â”œâ”€â”€ invoice-*.tsx       # Invoice components
â”‚   â”‚   â”œâ”€â”€ notification-*.tsx  # Notification components
â”‚   â”‚   â””â”€â”€ error-*.tsx         # Error handling
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                     # Utilities
â”‚   â”‚   â”œâ”€â”€ logger.ts           # Pino logging
â”‚   â”‚   â”œâ”€â”€ utils.ts            # General utilities
â”‚   â”‚   â”œâ”€â”€ date-utils.ts       # Date formatting
â”‚   â”‚   â””â”€â”€ trpc/               # tRPC client setup
â”‚   â”‚
â”‚   â”œâ”€â”€ server/                  # Server-side code
â”‚   â”‚   â”œâ”€â”€ auth/               # Authentication
â”‚   â”‚   â”‚   â”œâ”€â”€ session.ts      # Session management
â”‚   â”‚   â”‚   â””â”€â”€ password.ts     # Password hashing
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ db/                 # Database
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts        # Drizzle client
â”‚   â”‚   â”‚   â””â”€â”€ schema.ts       # Database schema
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ storage/            # Object storage
â”‚   â”‚   â”‚   â””â”€â”€ minio.ts        # MinIO client
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ lib/                # Server utilities
â”‚   â”‚   â”‚   â””â”€â”€ rate-limit.ts   # Rate limiting
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ cron/               # Scheduled tasks
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts        # Cron initialization
â”‚   â”‚   â”‚   â””â”€â”€ cleanup.ts      # Cleanup jobs
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ trpc/               # tRPC backend
â”‚   â”‚       â”œâ”€â”€ init.ts         # tRPC setup + procedures
â”‚   â”‚       â”œâ”€â”€ root.ts         # Root router
â”‚   â”‚       â””â”€â”€ routers/        # Feature routers
â”‚   â”‚           â”œâ”€â”€ auth.ts
â”‚   â”‚           â”œâ”€â”€ invoice.ts
â”‚   â”‚           â”œâ”€â”€ notification.ts
â”‚   â”‚           â”œâ”€â”€ admin.ts
â”‚   â”‚           â””â”€â”€ analytics.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware.ts            # Next.js middleware (auth + IP)
â”‚   â””â”€â”€ instrumentation.ts       # App instrumentation
â”‚
â”œâ”€â”€ drizzle/                     # Database migrations
â”‚   â”œâ”€â”€ 0001_initial.sql
â”‚   â”œâ”€â”€ 0002_*.sql
â”‚   â””â”€â”€ meta/
â”‚
â”œâ”€â”€ scripts/                     # Utility scripts
â”‚   â”œâ”€â”€ seed.ts                 # Database seeding
â”‚   â”œâ”€â”€ create-emergency-admin.ts
â”‚   â””â”€â”€ backups/                # Backup scripts
â”‚       â”œâ”€â”€ backup-postgres.sh
â”‚       â”œâ”€â”€ backup-minio.sh
â”‚       â”œâ”€â”€ restore-postgres.sh
â”‚       â””â”€â”€ restore-minio.sh
â”‚
â”œâ”€â”€ tests/                       # Test suite
â”‚   â”œâ”€â”€ setup.ts                # Test configuration
â”‚   â”œâ”€â”€ unit/                   # Unit tests
â”‚   â”‚   â”œâ”€â”€ date-utils.test.ts
â”‚   â”‚   â”œâ”€â”€ password.test.ts
â”‚   â”‚   â””â”€â”€ rate-limit.test.ts
â”‚   â””â”€â”€ integration/            # Integration tests
â”‚       â”œâ”€â”€ health.test.ts
â”‚       â””â”€â”€ security.test.ts
â”‚
â”œâ”€â”€ docs/                        # Documentation
â”‚   â”œâ”€â”€ ARCHITECTURE.md         # This file
â”‚   â”œâ”€â”€ LOGGING.md              # Logging system
â”‚   â”œâ”€â”€ MONITORING.md           # Health checks
â”‚   â”œâ”€â”€ BACKUP_SYSTEM.md        # Backup guide
â”‚   â”œâ”€â”€ TESTING.md              # Testing guide
â”‚   â””â”€â”€ RATE_LIMITING.md        # Rate limiting
â”‚
â”œâ”€â”€ config/                      # Configuration files
â”œâ”€â”€ public/                      # Static assets
â”‚
â”œâ”€â”€ docker-compose.yml           # Docker orchestration
â”œâ”€â”€ Dockerfile                   # App container build
â”œâ”€â”€ package.json                 # Dependencies
â”œâ”€â”€ tsconfig.json                # TypeScript config
â”œâ”€â”€ next.config.ts               # Next.js config
â”œâ”€â”€ drizzle.config.ts            # Drizzle ORM config
â”œâ”€â”€ vitest.config.ts             # Vitest config
â”œâ”€â”€ tailwind.config.js           # Tailwind CSS
â””â”€â”€ .env                         # Environment variables
```

---

## ğŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Security Stack                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Network Layer                                                â”‚
â”‚     â€¢ Docker internal network isolation                          â”‚
â”‚     â€¢ Only port 3000 exposed to host                            â”‚
â”‚     â€¢ PostgreSQL/MinIO internal only                            â”‚
â”‚                                                                  â”‚
â”‚  2. Middleware Layer (src/middleware.ts)                        â”‚
â”‚     â€¢ IP address extraction and tracking                        â”‚
â”‚     â€¢ Public path allow-listing                                 â”‚
â”‚     â€¢ Redirect logged-in users from auth pages                  â”‚
â”‚     â€¢ Redirect unauthenticated users to login                   â”‚
â”‚                                                                  â”‚
â”‚  3. Rate Limiting (In-Memory)                                    â”‚
â”‚     â€¢ Global: 300 requests/minute per IP                        â”‚
â”‚     â€¢ Auth endpoints: 10 requests/minute                        â”‚
â”‚     â€¢ Write operations: 100 requests/minute                     â”‚
â”‚     â€¢ Read operations: 500 requests/minute                      â”‚
â”‚                                                                  â”‚
â”‚  4. Authentication                                               â”‚
â”‚     â€¢ JWT tokens (ES256 algorithm)                              â”‚
â”‚     â€¢ HttpOnly, Secure, SameSite cookies                       â”‚
â”‚     â€¢ Session expiration (7 days)                              â”‚
â”‚     â€¢ Login attempt tracking                                    â”‚
â”‚                                                                  â”‚
â”‚  5. Password Security                                            â”‚
â”‚     â€¢ Argon2 hashing algorithm                                  â”‚
â”‚     â€¢ Minimum 8 characters                                      â”‚
â”‚     â€¢ Complexity requirements enforced                          â”‚
â”‚                                                                  â”‚
â”‚  6. Authorization (RBAC)                                         â”‚
â”‚     â€¢ Role-based access control                                 â”‚
â”‚     â€¢ Roles: user, accountant, admin                           â”‚
â”‚     â€¢ Protected tRPC procedures                                 â”‚
â”‚                                                                  â”‚
â”‚  7. HTTP Security Headers                                        â”‚
â”‚     â€¢ Strict-Transport-Security                                 â”‚
â”‚     â€¢ X-Frame-Options: SAMEORIGIN                              â”‚
â”‚     â€¢ X-Content-Type-Options: nosniff                          â”‚
â”‚     â€¢ X-XSS-Protection                                          â”‚
â”‚     â€¢ Content-Security-Policy                                   â”‚
â”‚     â€¢ Referrer-Policy                                           â”‚
â”‚                                                                  â”‚
â”‚  8. Data Protection                                              â”‚
â”‚     â€¢ Sensitive data redaction in logs                          â”‚
â”‚     â€¢ Private MinIO buckets                                     â”‚
â”‚     â€¢ Encrypted database connections                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Monitoring & Observability

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Monitoring Components                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Health Checks                                                â”‚
â”‚     â€¢ Endpoint: GET /api/health                                 â”‚
â”‚     â€¢ Checks: Database, MinIO, Uptime                          â”‚
â”‚     â€¢ Response: JSON with status codes                          â”‚
â”‚     â€¢ Docker: Automatic restart on unhealthy                    â”‚
â”‚                                                                  â”‚
â”‚  2. Structured Logging (Pino)                                   â”‚
â”‚     â€¢ Format: JSON in production, pretty in dev                 â”‚
â”‚     â€¢ Output: Console + Files (/app/logs/)                     â”‚
â”‚     â€¢ Files: app.log (all), error.log (errors)                 â”‚
â”‚     â€¢ Rotation: Manual or automated                             â”‚
â”‚     â€¢ Sensitive data: Automatically redacted                    â”‚
â”‚                                                                  â”‚
â”‚  3. Log Categories                                               â”‚
â”‚     â€¢ auth: Authentication events                               â”‚
â”‚     â€¢ database: Query operations                                â”‚
â”‚     â€¢ api: HTTP requests                                        â”‚
â”‚     â€¢ trpc: Procedure calls                                     â”‚
â”‚     â€¢ cron: Scheduled job execution                            â”‚
â”‚     â€¢ storage: File operations                                  â”‚
â”‚                                                                  â”‚
â”‚  4. Error Boundaries                                             â”‚
â”‚     â€¢ React error catching                                      â”‚
â”‚     â€¢ User-friendly error messages                              â”‚
â”‚     â€¢ Error logging to files                                    â”‚
â”‚     â€¢ Graceful degradation                                      â”‚
â”‚                                                                  â”‚
â”‚  5. Performance Tracking                                         â”‚
â”‚     â€¢ Request duration logging                                  â”‚
â”‚     â€¢ Slow query detection (>1s warning)                       â”‚
â”‚     â€¢ Database operation timing                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Background Jobs (Cron)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Scheduled Tasks (Daily 1 AM)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. cleanOldLoginLogs()                                         â”‚
â”‚     â€¢ Delete login logs older than 30 days                      â”‚
â”‚     â€¢ Keeps audit trail manageable                              â”‚
â”‚                                                                  â”‚
â”‚  2. cleanExpiredSessions()                                      â”‚
â”‚     â€¢ Remove expired session records                            â”‚
â”‚     â€¢ Prevents table bloat                                      â”‚
â”‚                                                                  â”‚
â”‚  3. cleanOldLoginAttempts()                                     â”‚
â”‚     â€¢ Delete login attempts older than 30 days                  â”‚
â”‚     â€¢ Security monitoring cleanup                               â”‚
â”‚                                                                  â”‚
â”‚  4. cleanOldNotifications()                                     â”‚
â”‚     â€¢ Delete notifications older than 2 days                    â”‚
â”‚     â€¢ Keeps notification table lean                             â”‚
â”‚                                                                  â”‚
â”‚  5. auditOrphanedFiles()                                        â”‚
â”‚     â€¢ Find MinIO files without database records                 â”‚
â”‚     â€¢ Log orphaned files for manual review                      â”‚
â”‚     â€¢ Does NOT auto-delete (safety)                            â”‚
â”‚                                                                  â”‚
â”‚  All jobs log:                                                   â”‚
â”‚  â€¢ Start time                                                    â”‚
â”‚  â€¢ Completion time                                               â”‚
â”‚  â€¢ Duration                                                      â”‚
â”‚  â€¢ Success/failure status                                        â”‚
â”‚  â€¢ Error details if failed                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ Network Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Docker Network: mobifaktura_network           â”‚
â”‚                          (Bridge Driver)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Internal Communication (No External Access):                    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚     app     â”‚                                                â”‚
â”‚  â”‚ (Next.js)   â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚         â”‚                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”                                                  â”‚
â”‚    â”‚         â”‚                                                  â”‚
â”‚    â–¼         â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚postgres minioâ”‚                                               â”‚
â”‚  â”‚:5432 â”‚  â”‚:9000 â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                  â”‚
â”‚  Service Names (Internal DNS):                                   â”‚
â”‚  â€¢ postgres:5432        â†’ PostgreSQL                            â”‚
â”‚  â€¢ minio:9000           â†’ MinIO API                             â”‚
â”‚  â€¢ mobifaktura_app:3000 â†’ Next.js app                          â”‚
â”‚                                                                  â”‚
â”‚  External Access (Port Mapping):                                 â”‚
â”‚  â€¢ localhost:3000  â†’ app:3000     (Application)                â”‚
â”‚  â€¢ localhost:9000  â†’ minio:9000   (MinIO API)                  â”‚
â”‚  â€¢ localhost:9001  â†’ minio:9001   (MinIO Console)              â”‚
â”‚                                                                  â”‚
â”‚  Volumes (Persistent Storage):                                   â”‚
â”‚  â€¢ postgres_data    â†’ PostgreSQL data                           â”‚
â”‚  â€¢ minio_data       â†’ MinIO objects                             â”‚
â”‚  â€¢ backup_data      â†’ Backup archives                           â”‚
â”‚  â€¢ app_logs         â†’ Application logs                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Performance Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Performance Metrics                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Database Queries:                                               â”‚
â”‚  â€¢ Indexed columns for fast lookups                             â”‚
â”‚  â€¢ Connection pooling via Drizzle                               â”‚
â”‚  â€¢ Prepared statements prevent SQL injection                    â”‚
â”‚                                                                  â”‚
â”‚  Rate Limiting:                                                  â”‚
â”‚  â€¢ In-memory (< 1ms latency)                                    â”‚
â”‚  â€¢ ~5MB memory for 10k unique IPs                              â”‚
â”‚  â€¢ Automatic cleanup after window                               â”‚
â”‚                                                                  â”‚
â”‚  Logging:                                                        â”‚
â”‚  â€¢ Pino: < 1ms per log                                          â”‚
â”‚  â€¢ Async I/O, non-blocking                                      â”‚
â”‚  â€¢ ~10-50 MB disk per day                                       â”‚
â”‚                                                                  â”‚
â”‚  File Storage:                                                   â”‚
â”‚  â€¢ MinIO: S3-compatible, optimized                              â”‚
â”‚  â€¢ Presigned URLs for direct access                             â”‚
â”‚  â€¢ No proxy through app server                                  â”‚
â”‚                                                                  â”‚
â”‚  Caching:                                                        â”‚
â”‚  â€¢ React Server Components (automatic)                          â”‚
â”‚  â€¢ Static assets cached                                         â”‚
â”‚  â€¢ API responses via Next.js cache                              â”‚
â”‚                                                                  â”‚
â”‚  Build:                                                          â”‚
â”‚  â€¢ Standalone output (optimized)                                â”‚
â”‚  â€¢ Sharp for image optimization                                 â”‚
â”‚  â€¢ Bundle size minimized                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Deployment Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Production Deployment                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Build Phase                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚     â”‚ npm run build                           â”‚                â”‚
â”‚     â”‚   â†“                                     â”‚                â”‚
â”‚     â”‚ Next.js compiles                        â”‚                â”‚
â”‚     â”‚   â†“                                     â”‚                â”‚
â”‚     â”‚ Standalone output created               â”‚                â”‚
â”‚     â”‚   â†“                                     â”‚                â”‚
â”‚     â”‚ .next/standalone + static assets        â”‚                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                  â”‚
â”‚  2. Docker Build                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚     â”‚ docker-compose build                    â”‚                â”‚
â”‚     â”‚   â†“                                     â”‚                â”‚
â”‚     â”‚ Multi-stage Dockerfile                  â”‚                â”‚
â”‚     â”‚   â”œâ”€ Builder: Install deps + build      â”‚                â”‚
â”‚     â”‚   â””â”€ Runner: Copy artifacts + serve     â”‚                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                  â”‚
â”‚  3. Service Startup                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚     â”‚ docker-compose up -d                    â”‚                â”‚
â”‚     â”‚   â†“                                     â”‚                â”‚
â”‚     â”‚ 1. PostgreSQL starts                    â”‚                â”‚
â”‚     â”‚ 2. MinIO starts                         â”‚                â”‚
â”‚     â”‚ 3. MinIO init creates bucket            â”‚                â”‚
â”‚     â”‚ 4. App waits for dependencies           â”‚                â”‚
â”‚     â”‚ 5. App starts on port 3000              â”‚                â”‚
â”‚     â”‚ 6. Backup service starts cron           â”‚                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                  â”‚
â”‚  4. Health Verification                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚     â”‚ Docker monitors health checks           â”‚                â”‚
â”‚     â”‚   â†“                                     â”‚                â”‚
â”‚     â”‚ All services report healthy             â”‚                â”‚
â”‚     â”‚   â†“                                     â”‚                â”‚
â”‚     â”‚ Application ready                       â”‚                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Technology Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Complete Tech Stack                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Frontend:                                                       â”‚
â”‚  â€¢ Next.js 16.1.1              (React Framework)                â”‚
â”‚  â€¢ React 19.2.3                (UI Library)                     â”‚
â”‚  â€¢ TypeScript 5.6.3            (Type Safety)                    â”‚
â”‚  â€¢ Tailwind CSS 3.4.14         (Styling)                        â”‚
â”‚  â€¢ Shadcn UI                   (Component Library)              â”‚
â”‚  â€¢ Radix UI                    (Headless Components)            â”‚
â”‚  â€¢ Lucide React                (Icons)                          â”‚
â”‚  â€¢ Recharts 3.5.1              (Charts)                         â”‚
â”‚  â€¢ html5-qrcode                (QR Scanner)                     â”‚
â”‚  â€¢ jspdf + pdfmake             (PDF Generation)                 â”‚
â”‚                                                                  â”‚
â”‚  Backend:                                                        â”‚
â”‚  â€¢ tRPC 11.0.0-rc.608          (Type-safe API)                 â”‚
â”‚  â€¢ Drizzle ORM 0.44.7          (Database ORM)                   â”‚
â”‚  â€¢ PostgreSQL 16               (Database)                       â”‚
â”‚  â€¢ MinIO                       (Object Storage)                 â”‚
â”‚  â€¢ Jose 5.9.6                  (JWT)                            â”‚
â”‚  â€¢ Argon2 0.41.1               (Password Hashing)               â”‚
â”‚  â€¢ Pino 9.5.0                  (Logging)                        â”‚
â”‚  â€¢ Zod 3.23.8                  (Validation)                     â”‚
â”‚                                                                  â”‚
â”‚  DevOps:                                                         â”‚
â”‚  â€¢ Docker                      (Containerization)               â”‚
â”‚  â€¢ Docker Compose              (Orchestration)                  â”‚
â”‚  â€¢ Alpine Linux                (Base Images)                    â”‚
â”‚                                                                  â”‚
â”‚  Testing:                                                        â”‚
â”‚  â€¢ Vitest 2.1.8                (Test Runner)                    â”‚
â”‚  â€¢ @vitest/ui                  (Test UI)                        â”‚
â”‚                                                                  â”‚
â”‚  Build Tools:                                                    â”‚
â”‚  â€¢ Turbopack                   (Dev Server)                     â”‚
â”‚  â€¢ ESLint 9.14.0               (Linting)                        â”‚
â”‚  â€¢ PostCSS                     (CSS Processing)                 â”‚
â”‚  â€¢ Sharp 0.34.5                (Image Optimization)             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ User Roles & Permissions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Role-Based Access Control                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ‘¤ USER                                                         â”‚
â”‚  â”œâ”€ Upload invoice images                                       â”‚
â”‚  â”œâ”€ View own invoices                                           â”‚
â”‚  â”œâ”€ Edit pending invoices                                       â”‚
â”‚  â”œâ”€ Delete own pending invoices                                 â”‚
â”‚  â”œâ”€ View notifications                                           â”‚
â”‚  â”œâ”€ Manage notification preferences                              â”‚
â”‚  â”œâ”€ Update profile                                               â”‚
â”‚  â””â”€ Export own invoices                                          â”‚
â”‚                                                                  â”‚
â”‚  ğŸ‘” ACCOUNTANT                                                   â”‚
â”‚  â”œâ”€ All USER permissions                                         â”‚
â”‚  â”œâ”€ View all pending invoices                                   â”‚
â”‚  â”œâ”€ Approve/Reject invoices                                     â”‚
â”‚  â”œâ”€ Request invoice re-review                                   â”‚
â”‚  â”œâ”€ View analytics dashboard                                    â”‚
â”‚  â”œâ”€ Export all invoices                                         â”‚
â”‚  â””â”€ Bulk operations on invoices                                  â”‚
â”‚                                                                  â”‚
â”‚  âš™ï¸ ADMIN                                                        â”‚
â”‚  â”œâ”€ All ACCOUNTANT permissions                                  â”‚
â”‚  â”œâ”€ User management (create, edit, delete)                     â”‚
â”‚  â”œâ”€ View all users                                              â”‚
â”‚  â”œâ”€ View login logs                                             â”‚
â”‚  â”œâ”€ System configuration                                         â”‚
â”‚  â”œâ”€ Bulk delete users                                           â”‚
â”‚  â””â”€ Full system access                                           â”‚
â”‚                                                                  â”‚
â”‚  ğŸš¨ EMERGENCY SUPER ADMIN                                       â”‚
â”‚  â”œâ”€ Hardcoded credentials in .env                              â”‚
â”‚  â”œâ”€ Bypass rate limiting                                        â”‚
â”‚  â”œâ”€ Access even if all DB admins locked                        â”‚
â”‚  â””â”€ Used for disaster recovery only                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Environment Variables

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Configuration Variables                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Database:                                                       â”‚
â”‚  â€¢ DATABASE_URL              Full connection string             â”‚
â”‚  â€¢ POSTGRES_USER             Database username                  â”‚
â”‚  â€¢ POSTGRES_PASSWORD         Database password                  â”‚
â”‚  â€¢ POSTGRES_DB               Database name                      â”‚
â”‚                                                                  â”‚
â”‚  MinIO Storage:                                                  â”‚
â”‚  â€¢ MINIO_ENDPOINT            Server hostname                    â”‚
â”‚  â€¢ MINIO_PORT                API port                           â”‚
â”‚  â€¢ MINIO_ACCESS_KEY          Access key                         â”‚
â”‚  â€¢ MINIO_SECRET_KEY          Secret key                         â”‚
â”‚  â€¢ MINIO_BUCKET              Bucket name                        â”‚
â”‚  â€¢ MINIO_USE_SSL             SSL enabled (false)                â”‚
â”‚                                                                  â”‚
â”‚  Authentication:                                                 â”‚
â”‚  â€¢ JWT_SECRET                Token signing key (32+ chars)      â”‚
â”‚  â€¢ SESSION_COOKIE_NAME       Cookie name                        â”‚
â”‚                                                                  â”‚
â”‚  Emergency Access:                                               â”‚
â”‚  â€¢ SUPER_ADMIN_EMAIL         Emergency admin email              â”‚
â”‚  â€¢ SUPER_ADMIN_PASSWORD      Emergency admin password           â”‚
â”‚                                                                  â”‚
â”‚  Application:                                                    â”‚
â”‚  â€¢ NEXT_PUBLIC_APP_URL       Public URL                         â”‚
â”‚  â€¢ NODE_ENV                  Environment (production/dev)       â”‚
â”‚  â€¢ LOG_LEVEL                 Logging level (info/debug)         â”‚
â”‚                                                                  â”‚
â”‚  Backup:                                                         â”‚
â”‚  â€¢ BACKUP_CRON_SCHEDULE      Cron expression (0 1 * * *)       â”‚
â”‚  â€¢ BACKUP_RETENTION_DAYS     Days to keep (30)                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Common Operations

### Starting the Application
```bash
docker-compose up -d
```

### Viewing Logs
```bash
# Real-time logs
docker logs mobifaktura_app -f

# Log files
docker exec mobifaktura_app cat /app/logs/app.log
docker exec mobifaktura_app cat /app/logs/error.log
```

### Database Operations
```bash
# Run migrations
npm run db:migrate

# Open Drizzle Studio
npm run db:studio

# Seed database
npm run db:seed

# Create emergency admin
npm run create-emergency-admin
```

### Backup Operations
```bash
# Manual backups
npm run backup:postgres
npm run backup:minio
npm run backup:all

# List backups
npm run backup:list

# Restore backups
npm run restore:postgres
npm run restore:minio
```

### Testing
```bash
# Run tests
npm test

# Run with UI
npm run test:ui

# Run once
npm run test:run

# With coverage
npm run test:coverage
```

### Health Checks
```bash
# Check application health
curl http://localhost:3000/api/health

# Check container health
docker ps

# Check specific service
docker inspect mobifaktura_app | grep -A 10 Health
```

---

## ğŸ“– Related Documentation

- **[LOGGING.md](./LOGGING.md)** - Complete logging guide
- **[MONITORING.md](./MONITORING.md)** - Health checks and monitoring
- **[BACKUP_SYSTEM.md](./BACKUP_SYSTEM.md)** - Backup and restore procedures
- **[TESTING.md](./TESTING.md)** - Testing guide
- **[RATE_LIMITING.md](./RATE_LIMITING.md)** - Rate limiting details
- **[ADMIN_README_SNIPPET.md](./ADMIN_README_SNIPPET.md)** - Admin features

---

## ğŸ“ Architecture Principles

### 1. **Separation of Concerns**
- Clear boundaries between layers
- Frontend/Backend split via tRPC
- Database abstraction via Drizzle ORM
- Storage abstraction via MinIO client

### 2. **Type Safety**
- TypeScript throughout
- tRPC for end-to-end type safety
- Zod for runtime validation
- Drizzle for typed queries

### 3. **Security First**
- Defense in depth (multiple layers)
- Least privilege (RBAC)
- Secure defaults
- Regular security updates

### 4. **Observability**
- Structured logging everywhere
- Health checks for all services
- Error tracking and reporting
- Performance monitoring

### 5. **Resilience**
- Automatic service restart
- Health-based recovery
- Data backup automation
- Graceful error handling

### 6. **Maintainability**
- Clear project structure
- Comprehensive documentation
- Automated testing
- Consistent code style

---

**Last Updated:** December 27, 2025
**Version:** 1.0.0
